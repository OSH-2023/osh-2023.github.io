
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../score/">
      
      
        <link rel="next" href="../../lab4/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.0, mkdocs-material-9.1.19">
    
    
      
        <title>跋：实验反馈 - USTC OSH 2023 课程主页</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.eebd395e.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://101.ustclug.org/css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#实验反馈" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="USTC OSH 2023 课程主页" class="md-header__button md-logo" aria-label="USTC OSH 2023 课程主页" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            USTC OSH 2023 课程主页
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              跋：实验反馈
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/OSH-2023/OSH-2023.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OSH-2023/OSH-2023.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="USTC OSH 2023 课程主页" class="md-nav__button md-logo" aria-label="USTC OSH 2023 课程主页" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    USTC OSH 2023 课程主页
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/OSH-2023/OSH-2023.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OSH-2023/OSH-2023.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        首页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          实验零
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          实验零
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab0/" class="md-nav__link">
        零：简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab0/linux/" class="md-nav__link">
        一：Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab0/git/" class="md-nav__link">
        二：Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab0/markdown/" class="md-nav__link">
        三：Markdown
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab0/programming/" class="md-nav__link">
        四：编程说明
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          实验一
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          实验一
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab1/" class="md-nav__link">
        零：简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab1/phase1/" class="md-nav__link">
        一：Linux 编译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab1/phase2/" class="md-nav__link">
        二：创建初始内存盘
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab1/phase3/" class="md-nav__link">
        三：添加自定义系统调用
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          实验二
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          实验二
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab2/" class="md-nav__link">
        零：简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab2/dir/" class="md-nav__link">
        一：目录导航
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab2/pipe/" class="md-nav__link">
        二：管道
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab2/redirection/" class="md-nav__link">
        三：重定向
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab2/signal/" class="md-nav__link">
        四：信号处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab2/fgbg/" class="md-nav__link">
        五：前后台进程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab2/optional/" class="md-nav__link">
        六：「可选」拓展功能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab2/feedback/" class="md-nav__link">
        跋：实验反馈
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          实验三
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          实验三
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        零：简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        一：HTTP&socket 简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../required/" class="md-nav__link">
        二：必做部分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../optional/" class="md-nav__link">
        三：选做部分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../score/" class="md-nav__link">
        四：测试及评分
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          跋：实验反馈
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        跋：实验反馈
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#代码编写与调试" class="md-nav__link">
    代码编写与调试
  </a>
  
    <nav class="md-nav" aria-label="代码编写与调试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#本实验的常见问题" class="md-nav__link">
    本实验的常见问题
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#锁" class="md-nav__link">
    锁
  </a>
  
    <nav class="md-nav" aria-label="锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#自旋锁" class="md-nav__link">
    自旋锁
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#互斥锁" class="md-nav__link">
    互斥锁
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#协程" class="md-nav__link">
    协程
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          实验四
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          实验四
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab4/" class="md-nav__link">
        零：简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab4/Ceph/" class="md-nav__link">
        一：Ceph
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lab4/Ray/" class="md-nav__link">
        二：Ray
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#代码编写与调试" class="md-nav__link">
    代码编写与调试
  </a>
  
    <nav class="md-nav" aria-label="代码编写与调试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#本实验的常见问题" class="md-nav__link">
    本实验的常见问题
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#锁" class="md-nav__link">
    锁
  </a>
  
    <nav class="md-nav" aria-label="锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#自旋锁" class="md-nav__link">
    自旋锁
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#互斥锁" class="md-nav__link">
    互斥锁
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#协程" class="md-nav__link">
    协程
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  <!-- overrides/partials/content.html -->

<h1 id="实验反馈">实验反馈<a class="headerlink" href="#实验反馈" title="Permanent link">&para;</a></h1>
<p>Lab3 主要是 Linux 上的网络编程，我们希望通过这个实验帮助大家建立对线程和锁的直观了解。</p>
<h2 id="代码编写与调试">代码编写与调试<a class="headerlink" href="#代码编写与调试" title="Permanent link">&para;</a></h2>
<p>在 lab3 中我们的代码会涉及到线程间的并发执行，这会带来很多竞态条件相关的 bug（例如两个线程对同一个内存地址的读写），你可能会需要一些趁手的调试工具：</p>
<ul>
<li>gdb：gdb 虽然初看起来比较劝退，但对于一些复杂应用程序的 debug 几乎是必不可少的。gdb 也有一些漂亮的调试器前端可以搭配使用。具体使用请参照网上的各类教程文档。</li>
<li>tsan: 在编译 C/C++ 代码时，可以加上 <code>-fsanitize=thread</code> 参数。你可能已经比较熟悉 <code>-fsanitize=address</code> 参数了：后者可以在程序出现内存错误时提供详细的错误信息，与之类似，前者可以帮你发现一些线程相关的错误，如数据竞争等。除了 asan 和 tsan 之外，还有 msan 和 ubsan 可以帮你进行更多运行时检查。具体使用同理请参照文档。</li>
</ul>
<p><strong>计算机永远不会出错</strong>，若计算机出现不符合自己预期的行为，那原因一定是有迹可循的。锻炼自己的调试能力可以很好的帮助解决各种问题。</p>
<h3 id="本实验的常见问题">本实验的常见问题<a class="headerlink" href="#本实验的常见问题" title="Permanent link">&para;</a></h3>
<p>如果你没有选做缓存部分，你可能不太会遇到复杂的竞态条件。但是一个常见的问题是：</p>
<div class="highlight"><pre><span></span><code><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">clnt_sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accept</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clnt_addr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">clnt_addr_size</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="kr">thread</span><span class="p">;</span>
<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">handle_clnt</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">clnt_sock</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_detach</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span><span class="c1">//分离线程</span>
<span class="p">}</span>
</code></pre></div>
<p>以上实现每个线程从 <code>&amp;clnt_sock</code> 中获取参数。但线程创建后并不会立即执行，因此可能出现：</p>
<p><code>clnt_sock = 1 -&gt; 线程1创建 -&gt; clnt_sock = 2 -&gt; 线程2创建 -&gt; 线程1调度 -&gt; 线程2调度</code></p>
<p>此时线程 1 读取 <code>&amp;clnt_sock</code> 得到的值是 2，与预期不符。</p>
<p>这个问题在开启 <code>-fsanitize=thread</code> 编译选项后是可以被运行时检测到的。</p>
<h2 id="锁">锁<a class="headerlink" href="#锁" title="Permanent link">&para;</a></h2>
<p>不管是操作系统内核还是应用程序，对共享数据的访问都是常见的。对于多核 CPU，一般来说内核是可以同时在多个 CPU 核心上同时运行的（这里需要补充一个对操作系统内核的感性认识，在完成了系统资源的初始化后，操作系统就成为了 interrupt/trap/exception handler，而当多个核心上运行的线程都在调用 syscall，或者同时陷入异常（如除零异常，缺页异常）时，显然应该允许多个核心都进入内核态）。</p>
<p>此时，对于内核中一些数据结构，例如空闲页链表或各种设备寄存器的内存映射地址的访问就出现了数据竞争。此时必须引入锁机制保证数据更新的正确性，以及<strong>操作的原子性</strong>。锁是针对某个操作而言的，而不是对某个内存地址而言的。例如，多线程同时进行链表的插入，需要对链表加锁，而不是对某个结点上面的 <code>next</code> 指针加锁。</p>
<p>对于操作系统内核中此类竞态条件，最经常被使用的是自旋锁（spinlock）。</p>
<h3 id="自旋锁">自旋锁<a class="headerlink" href="#自旋锁" title="Permanent link">&para;</a></h3>
<p>自旋锁常常通过指令集提供的对内存的原子指令实现。例如 RISC-V 指令集提供了 <code>amoswap</code> 原子交换指令，该指令会将 R1 寄存器的值写入对应内存地址并将地址原先的值保存到 R2 寄存器。通过 <code>amoswap</code> 原子指令，我们可以实现 test-and-set 原子操作。例如，我们可以用某个变量表示锁是否被持有：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">spinlock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">locked</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>对于加锁操作，我们可以循环调用 <code>amoswap</code> 不断向内存中写入 1。如果发现地址原先的值是 1，那么说明锁原先就已经被持有，我们需要继续循环以获取锁；如果发现地址原先的值是 0，那么说明原先锁没有被持有，此时我们就获取到了锁，可以退出循环。</p>
<p>对于解锁操作，我们直接向内存中写入 0 即可。注意这里的写入也需要用原子指令。</p>
<details class="question" open="open">
<summary>为什么不直接 store 0?</summary>
<p><code>store</code> 指令本身并不提供原子性保证，例如 <code>store</code> 指令可能会先加载 cache line, 再向 cache line 中写入数据，注意这里不再只是简单的 RAM 模型。</p>
<p>实际自旋锁的实现还有一些值得注意的细节，例如获取自旋锁前应该先关闭中断，避免中断处理程序中再次申请同一个锁，在释放锁后再打开中断（同一时刻可能会持有多把自旋锁，因此往往这里会设计一个 <code>push</code> 和 <code>pop</code> 中断开关的机制）。以及实际内存还有内存序等更多细节需要考虑，可能会需要屏障指令来保证锁之间操作的原子性。</p>
</details>
<h3 id="互斥锁">互斥锁<a class="headerlink" href="#互斥锁" title="Permanent link">&para;</a></h3>
<p>一个用户程序可能需要多个线程并行执行，此时数据的竞争也需要用锁来解决。</p>
<p>但用户程序往往不会直接使用自旋锁，一方面自旋锁需要确保在获取锁和释放锁之间线程不能被调度走，否则另一个线程会 busy-loop 很长时间；另一方面用户态程序可能会对某些复杂操作加锁，这时我们希望暂时获取不到锁的线程可以休眠，操作系统调度其他的线程执行。</p>
<p>为了满足上面的需求，互斥锁就诞生了。互斥锁是操作系统面向用户态程序提供的一种锁，当获取失败时，允许操作系统调度其他线程执行。</p>
<p>当然，切换线程的开销毕竟还是很大的，所以一个高性能的程序会尽量减少锁的使用。一个简单的策略是，对数据哈希分桶，每个桶对应一把锁以替换原来的大锁。</p>
<h2 id="协程">协程<a class="headerlink" href="#协程" title="Permanent link">&para;</a></h2>
<p>（本部分内容仅供拓展了解，参考自 <a href="https://jyywiki.cn/OS/2022/labs/M2">NJU OS 2022 M2 libco</a>，协议 <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0 License</a>）</p>
<p>我们注意到多个线程可以提高程序的并行性，但程序本身根据目的也分为计算密集型程序和 I/O 密集型程序两种。对于前者，合适的并行策略可以几乎线性的提高程序的运行效率。但是对于后者，瓶颈主要在操作系统读取文件并拷贝回用户态地址空间，本身程序执行所占的时间并不多，因此事实上可能并不需要多线程并行（同一时间运行多个任务），而只需要能应对并发（同时到达大量任务，但并不需要同时处理）的情景即可。而且，线程切换本身也有大量的开销，会带来页表的切换和缓存的失效。</p>
<p>我们有没有可能在不借助操作系统 API (也不解释执行代码) 的前提下，用一个进程 (状态机) 去模拟多个共享内存的执行流 (状态机)？</p>
<p>答案是可以的。线程作为串行执行调度代码的基本单位，体现这一点的就是每个线程都具有独立的栈帧链和寄存器环境（除此之外，堆，程序代码，全局变量等都是共享的）。因此，如果我们采取某种机制保存并恢复栈帧链和寄存器，就可以在多个执行环境之间切换了。这样，我们就在用户态实现了协作多任务的调度，一般也称为协程。之所以说是协作多任务，是因为这种多任务需要每个任务主动让出自己的执行权，执行调度代码切换到别的任务。</p>
<p>对于保存寄存器环境，C 语言标准库中提供了很方便的 <code>setjmp</code> 和 <code>longjmp</code> 函数。当然实际上在切换执行环境时，我们并不需要保存所有的寄存器，只需要保存被调用者保存寄存器即可（想一想为什么）。</p>
<blockquote>
<p>无论你觉得你理解得多么“清楚”，亲手调试过代码后的感觉仍是很不一样的。</p>
</blockquote>
<p>我们非常欢迎感兴趣的同学尝试 <a href="https://jyywiki.cn/OS/2022/labs/M2">NJU OS 2022 M2 libco</a>，你可以联系助教获取一份参考实现（出于外校课程实验要求，答案并不直接开源）。</p>
<p>本学期有关操作系统具体实现的实验到此就结束了，由于课程安排的原因，我们并没有选择某个具体的内核实现讲解。如果你对操作系统的具体实现有兴趣（包括页表，中断，线程调度等），我们推荐以下资源以供进一步学习：</p>
<ul>
<li><a href="https://csdiy.wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/">MIT6.S081</a>, 包含经典的 xv6 操作系统及丰富的中英文资料。xv6 是一个极为精简的 RISC-V 操作系统（事实上 RISC-V 提供了比 x86 简单得多的硬件抽象）。</li>
<li><a href="https://csdiy.wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/NJUOS/">NJU OS</a>，这门课的实验评测并未公开，但是 Bilibili 上可以看到完整的视频录课。</li>
</ul>

<h2 id="__comments"></h2>
<div id="utteranc-thread"></div>
<script
  src="https://utteranc.es/client.js"
  repo="OSH-2023/osh-2023.github.io"
  issue-term="pathname"
  label="comments"
  crossorigin="anonymous"
  async
></script>
                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../score/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 四：测试及评分" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                四：测试及评分
              </div>
            </div>
          </a>
        
        
          
          <a href="../../lab4/" class="md-footer__link md-footer__link--next" aria-label="下一页: 零：简介" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                零：简介
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.footer"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>